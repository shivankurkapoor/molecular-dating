from Bio import SeqIO
import sys

#parameters
MATCH_REWARD = 1#10#1
MISMATCH_PENALTY = -1#-2#-1
GAP_OPENING_PENALTY = -5#-15#-3
GAP_EXTENSION_PENALTY = -2#-7
NEG_INF = float('-inf')

def get_current(current, M, Ix, Iy, from_m, from_x, from_y):
	#print 'current in get_current: ', current
	return {
		from_m : M,
		from_x : Ix,
		from_y : Iy
	}[current]


def needleman_using_affine_penalty(s1, s2):
	if len(s1) == 0 or len(s2) == 0:
		print 'Error: One of the sequences is empty'
		return
	m = len(s1)
	n = len(s2)

	'''
	3 matrices required for affine penalty
	M: best score given that s1[i] is aligned to s2[j]
	Ix: best score given that s1[i] is aligned to a gap
	Iy: best score given that s2[j] is aligned to a gap
	'''
	M = [[(0,0) for j in range(n+1)] for i in range(m+1)]
	Ix = [[(0,0) for j in range(n+1)] for i in range(m+1)]
	Iy = [[(0,0) for j in range(n+1)] for i in range(m+1)]
	#M = [[0]*(n+1) for i in range(m+1)]
	#Ix = [[0]*(n+1) for i in range(m+1)]
	#Iy = [[0]*(n+1) for i in range(m+1)]

	#initialization
	from_m = 3
	from_x = 2
	from_y = 1
	M[0][0] = (0, 0)
	Ix[0][0] = (GAP_OPENING_PENALTY, 0)
	Iy[0][0] = (GAP_OPENING_PENALTY, 0)
	for i in range(1,m+1):
		M[i][0] = (NEG_INF, 0)
		Ix[i][0] = (GAP_OPENING_PENALTY + GAP_EXTENSION_PENALTY * i, from_x)
		Iy[i][0] = (NEG_INF, 0)

	for j in range(1,n+1):
		M[0][j] = (NEG_INF, 0)
		Ix[0][j] = (NEG_INF, 0)
		Iy[0][j] = (GAP_OPENING_PENALTY + GAP_EXTENSION_PENALTY * j, from_y)

	#operate
	for i in range(1, m+1):
		for j in range(1, n+1):
			add_factor = MISMATCH_PENALTY
			if s1[i-1] == s2[j-1]:
				add_factor = MATCH_REWARD
			M[i][j] = max(
					(M[i-1][j-1][0] + add_factor, from_m),
					(Ix[i-1][j-1][0] + add_factor, from_x),
					(Iy[i-1][j-1][0] + add_factor, from_y)
					)

			Ix[i][j] = max(
					(M[i-1][j][0] + GAP_OPENING_PENALTY + GAP_EXTENSION_PENALTY, from_m),
					(Ix[i-1][j][0] + GAP_EXTENSION_PENALTY, from_x)
					)

			Iy[i][j] = max(
					(M[i][j-1][0] + GAP_OPENING_PENALTY + GAP_EXTENSION_PENALTY, from_m),
					(Iy[i][j-1][0] + GAP_EXTENSION_PENALTY, from_y)
					)
	'''
	print 'M'
	for i in range(len(M)):
		print M[i]

	print '\n'
	print 'Ix'
	for i in range(len(Ix)):
		print Ix[i]

	print '\n'
	print 'Iy'
	for i in range(len(Iy)):
		print Iy[i]
	'''

	#traceback
	alignseq1 = []
	alignseq2 = []
	if M[m][n][0] > Ix[m][n][0]:
		if M[m][n][0] > Iy[m][n][0]:
			current = M
		else:
			current = Iy
	else:
		if Ix[m][n][0] > Iy[m][n][0]:
			current = Ix
		else:
			current = Iy

	i = m
	j = n
	while i > 0 or j > 0:
		#print '\ncurrent:'
		#print current[i][j]
		#print 'current matrix'
		#print current
		if current == M:
			#print 'inside M'
			#print current[i][j][0], '\n'
			current = get_current(current[i][j][1], M, Ix, Iy, from_m, from_x, from_y)
			i -= 1
			j -= 1
			alignseq1.append(s1[i])
			alignseq2.append(s2[j])
		elif current == Ix:
			#print 'inside Ix'
			#print current[i][j][0], '\n'
			current = get_current(current[i][j][1], M, Ix, Iy, from_m, from_x, from_y)
			i -= 1
			alignseq1.append(s1[i])
			alignseq2.append('-')
			#current = get_current(current[i][j][1], M, Ix, Iy, from_m, from_x, from_y)
		elif current == Iy:
			#print 'inside Y'
			#print current[i][j][0], '\n'
			current = get_current(current[i][j][1], M, Ix, Iy, from_m, from_x, from_y)
			j -= 1
			alignseq1.append('-')
			alignseq2.append(s2[j])
			#current = get_current(current[i][j][1], M, Ix, Iy, from_m, from_x, from_y)
	alignseq1.reverse()
	alignseq2.reverse()
	return ''.join(alignseq1), ''.join(alignseq2)

def hammingDistance(s1, s2, gapsIgnore):
    matches, mismatches, insertionErrors, deletionErrors = 0, 0, 0, 0
    #bases = {'A':0, 'C':0, 'G':0, 'T':0, 'N':0}
    for i in range(len(s1)):
    	if i >= len(s2):
    		break
    	if s1[i] == '-' and s2[i] == '-' or s1[i] == 'N':
    		continue

        if s1[i] == s2[i]:
            matches += 1
            '''
            score = scores[i-deletionErrors]
            if signalHistogram.has_key(score):
                signalHistogram[score] += 1
            else:
                signalHistogram[score] = 1
            '''
        elif s1[i] == '-' or s1[i] == '_':
            insertionErrors += 1
            '''
            score = scores[i-deletionErrors]
            if errorHistogram.has_key(score):
                errorHistogram[score] += 1
            else:
                errorHistogram[score] = 1
            '''
        elif s2[i] == '-' or s2[i] == '_':
            #bases[s1[i]] += 1
            deletionErrors += 1
        else:
            mismatches += 1
            '''
            score = scores[i-deletionErrors]
            if errorHistogram.has_key(score):
                errorHistogram[score] += 1
            else:
                errorHistogram[score] = 1
            '''
    #return matches, mismatches, insertionErrors, deletionErrors
    #print 'mismatches: ', mismatches
    #print 'insertionErrors: ', insertionErrors
    #print 'deletionErrors: ', deletionErrors
    #print bases
    if gapsIgnore:
    	return mismatches + abs(len(s1)-len(s2))
    return mismatches + insertionErrors + deletionErrors

inputfile = sys.argv[1]
gapsIgnore = sys.argv[2]
gapsIgnore = True if gapsIgnore == 'nogaps' else False
handle = open(inputfile)
records = SeqIO.parse(handle, 'fasta')
rec = next(records)
s1 = str(rec.seq).replace('-','').upper()
rec = next(records)
s2 = str(rec.seq).replace('-','').upper()
#s1 = '--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T------A-----A---T---A---------------C----C---G-----C----A-----T----------------G-------------C------------Tg------------GT----G---C-----T-------C-----T-----T-----T---C---------A--C--------A-A---------------G---A-----C-----G-----G------A----T----C---AC---------TAA--T--ACcgcaaa------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------GT--G---C---T---T------G----A---G----G----A---G----------G---G---------------G--C---T----T----G----T-----C----T--------C----C---G-------A---------------T----T--------A-------G--C---T----------A---------------G------T----T---------G-----G-----T------G------G----G----------G-------------------------T---------A------A----------C---------------------------------------G-------G----------------------------C------C------T----A---------C-------C-----A------A--------------------------G---G---------C----G------A-------T-------G----A-----------------------------T--------------------------------C---G----G---------------T---------A------G-----C--------T----G----------G-----T---C----T-------------G---------A-------G---------A--------------------------------------G---G---A----T-------G------G--------T---------C-----A----------G-----C------------------------------------------------------C----A-----C------------------------------------------------------------A-----C------T-----G-----G-----G---A-------------------C---------T--------G-------------------------A--------G-------------------------------A-------C-----------------A--------------C------G-------------------------------------------------------------------------------G---C----C-----C-----A-----G------------------A----C------T-----C-----C--------T-----------A----------------C----------G------------------------------------------------------G-----G-------A------G--------G------C------A----------------------------------------------G---C-----A-------------------------G----C----A---A------------------------------------------------------------G---------G------------A-----A------------T----------------C---T--------T----G----G----G------------C-------------------------------------A-----A-----T----G-----G----G---C------------G-----------------------------A--------A------A----------------------------------------------------G---C----C-----T----G----A-------------C---C----C------------------------------A---------G-------C----G---------A--------------------------C-----G----C----------C----G----C----------G------------------------T-------G-----A-----G----G----------G---------A-----------------------------T---------------------G-----------------A----------C----G----G-----C---C-----------T---------------------------T-----------C----------------------------G------------------------G---G----T----T---------G------T-----------A--------A----A-------------C----C----T----C-----------------T---T-------T-----------T-----C-----T-----C----A----G---G-----G-----A---A--G---Aataa-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------TG-A-----C---G---G--T------A--------C----C-----T-----G----A-------G------G-------A------------A-----------T--------A-----------A------G-----T-------C-------T----C---------G-------------G--------C-----------T-----A-----------------A------C----T-----A-----C-----G--------T-------------G---------------C--------------------------C----------------A-------G-----C----------A---------------------------G-----------------C-------C------------------------------------------------------------G-----C-----G--------G------T---------A----------A--------T-------A---------------------------------------------------------------------------C-----G----T----A----G-----------------G------A------G-----G------C---G--------------------------------------------A----G-----C----G---------T----T---------------------------------------------A-----T---C---C-------------------------------------G---------------------------------------G------------A----------------------------------------------------------------------------------T-------------------------------------------------T-------------------------------------------------------------------T-------------------------------------------------------A----------------------------------------T--------------------------------------------------T------------------------------G-----G---G----C---------G------------------T-------------------------------------------------A------------------------------------------------------------A------------------------------------------------------------------------------------------A------G-----------------T--G----G-----G-----C------------------G---T---------------A-----G-------G----T-------------------------------G-------G---T-------C-----T----T---T---C---------------------------------------------------------A---A---G------T-------C---------G-------G--------A-----T----G---T--G-------------------------A-----------------------------------------------------------A---------------------------------A---------------------------------------T---C----T----C----C----------C-------G-----G-----------C-----------------T-----C---------A----------------------A------------------------------------------------------------C-----T-----G-----G---------G-------A---G---G--G------------------------------------------G--T-----C----A----T----C---------C----------G-------A-----T-----A-----------C-----T------------------------------------------G---T------T---G-------G-----A-------C---------T--------------------------------T----------------G------A-----G------T---A------C-------A---G----C---A---------G-------------G----G-----G---A----A-----A----A--T------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------G--G-------A-----A-----T----T-----C----C---------C---------G-----G----T--------------G-------------------------------------T-----------------A-------G----T---G----------G---------T--------------------G--------------------------------------------------------------A-----------------------------------------A--------A-------------------------------------------------------------T----G------C----G-----T------A-----G-----A--T---------------------------------------------------------A----T-----C-------G----------G------G------A----G-----G-----A------------------------------A---C--------A-----------C-----------------------------------------C----------------------------------------------------A---G---------A--------------------------------------------------------------------G---G---C---------------G------A--------------------------------A--------------------------------------G---------------------------------------------------------------------------G----C----------------------------------------------------------------G----------A----T---T----T---------T-----C-------C-----A-------------------------------------------------------------G----G-----C----T----G-----A----------------------------A---A-----------C------T------------G---A-----C-----------------------------------------------------------A-----C----T------------------------------------------------------------G--AG---------------------------------G---C---C-------C-----------------------------------------------------------------G---------------------------------------A------------------------------------------------A---------------------------------------------A-------G----------C-------G----------T----------G-----G------------G------------------------------------------------------------G------------------------------------A-----G---C-------G------------------------------------------A-----------------A------C----A------G----G---------------A-----------------T-------------T--------------------A---------------------------------G--------A-------------------------T---------A-----C---------------------------------------------C---C-------T-----G---------G--------T-----A--------------------------------G---T-----------------------C----C----------A----C------G-----C---------------C------------------T------------------------T-----------A----------------A---------A-------C--------T---------A----------T------G----G----G------T----A-----C--------T----------A----G---G----T---A----T---A---G--G-GAgtatcgaccc-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------TT-T---C---T----G----T----G----C----C--------G----------A----------A-----G------C----------T--------A----------A----C----------------G------C----------T----T------T-----A------A-----------------G------T-------A--------C----------C-----C---------------------------C----------G----C----C------------------T---------G----G----G---------G----------A--------------------G------------T-------A------------------------------------C--------G----G----------T-----T--------G--------------------------------C-----------------A---------------A-------------------------------------------------G------A-------C-----T-------A---------------A-----A--------A--------------------------------------------------C-----T-----C--------------A-------------------A---------------A-------------------------------------G---------------------------------G------------------A----------------------A-------------------------T------T---G---------------A---C------G--------------------------------------------------G--------G----G---------G------C-----------------C-----C-----G--------------------------------C-----------------A--C--------------A--------------------------------------------------------A------------G------------C-------A----G--------C-----------G---------------G------A---------G------C-------G--------------------T--------G----------T------G-------G-----T-----------------T------------------------------T---------A-----------------------A-------------T--------T-----T----G------------A---------T--------------------G-------C-----------------------------T----------A----------------C-------A----------------------------------C---G--------A-------A----------------G------------A--------A-------C------------C-----T------------C---------------------A----C----C---A-------A------G---G---C----------T-------------------T----------G------------------A---------------C------A---T--G-------T---T--A---G-Aag------------T-----A-G--T---G---A--A----C---C-----G------A-----A-----A---------G--G---G--G--A-ACgacctgtcaaatcagga-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------GC--T--A--------T-----C----A---C---------A------G---G---------T----G-----C---T----G-----------C-----------------A----T----G-----G----C--------------T--------G---T-------C---G----------T----------------C----------------A--------G------C----------T------C----G-------T-----G--------C--C-----------G------------------------T-------------G------A-----------------------G----G----T-----------------G--------------------------------T------A----T----G-----G-----T--------T--------A-----------A---------G---------T--------------------------C---C----T-----G-------C--------A-------------------A----C----------G------A------G-------C--------------------G--------C--------------------A--------A----------C----C----C----T----T------------A-----T----T---G-----C-------C---A----G---------T-------T-----A---------------TA----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------T-----T-----T----T--------C----T----G----G--------C-------G----A---------T----------A------C----T------G-------C------C---T----C--G---------C-----------------------A------A--------------A----A--------------------------------C--G---G-------G-------G------A-----G------G---------------------A---------A------G----G--T----------------------------G---G-----G----G------------A-----T-----G-----A--------------------------C----G------T-------C-------A------A--G------T------C------A-----G-------C---A--------------T---G-----G----C------------------------------------------------------------C---T--------T--------T----A--T----------------------G---C-----C-------T-------T------G------G------G------C--T-------------------------------------A----C-------A---------C----A-----C----------A-------C------G-------C-----T------A------C---------------------------A---------------------A-----------------------T-------G----G------G---------C----G-----G--C-----------A---------------------------C---------------------------------------------------------A-------------A---------------------------T-----G----G-----G----------T----------------------------------------T--------------G----C-------C------------A-----------------C----C---G--G---------G------------T----------G-------------------A-------------------------C---C------G---G------G-----A-----------------------------------G----C------T----A-----A--T---------------------------------------------------------------------------------------------------------------C---C----C-----C------------------A----A---A-------------------------------------A---C---C----G----C-------C-------C-------------------------------------------------------T------------C----------------------------------------------------------------------------------A------------G---------T----------------------------------------------------------T---C--------T-------------------------G-----------------A------T---C----G----C-------A----G----G-------C-------------T------G----------------------------A-----------A-------A---------C--------C---------C--------------G----C------C----T----G----C----G-----G--------G-------A----A----------------------G----------T----C-------G-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------'
#s1 = s1.replace('-','').upper().replace('N','')
print 'original hd: '
print hammingDistance(s1, s2, True)
align1, align2 = needleman_using_affine_penalty(s1, s2)
print len(align1)
print len(align2)
hd = hammingDistance(align1, align2, gapsIgnore)
print 'new hd: ', hd
f = open('output.fasta', 'w')
f.write('>rdp ' + str(hd) + '\n')
f.write(align1 + '\n')
f.write('>user\n')
f.write(align2 + '\n')
f.close()




